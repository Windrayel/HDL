#include "mem.h"

Mem::Mem(sc_module_name nm)
    :sc_module(nm),
    clk_i("clk_i"),
    addr_bi("addr_bi"),
    data_bi("data_bi"),
    data_bo("data_bo"),
    wr_i("wr_i"),
    rd_i("rd_i")
{

    data_bo.initialize(0);
    SC_THREAD(mem_init);
    
    SC_METHOD(bus_write);
    sensitive << clk_i.pos();
    
    SC_METHOD(bus_read);
    sensitive << clk_i.pos();

}

Mem::~Mem()
{
}

void Mem::bus_read()
{
    if(wr_i.read())
        neuron[0][addr_bi.read()] = data_bi.read();
}

void Mem::bus_write()
{
    if(rd_i.read())
        data_bo.write(neuron[0][addr_bi.read()]);
}

void Mem::mem_init() 
{
    std::vector<int> layers{ 49, 5, 5, 3 };
    neuron.resize(layers.size());


    for (size_t k = 0; k < layers.size(); k++) {
        neuron[k].resize(layers[k]);
    }

    weights = { {{0.530119, -0.740887, 0.484779, -0.775977, -0.759393, 0.824761, 0.779269},
{0.414915, 0.0731108, 0.370176, 0.41132, -0.0507705, -0.427412, 0.329626},
{-0.428725, 0.532043, 0.443809, 0.567228, 0.739936, 0.214857, 0.588609},
{-0.894422, 0.10013, 0.289422, 0.197732, 0.839945, -1.0418, 0.320734},
{0.189539, 0.127489, -0.0596513, -0.0385717, -0.942767, -0.268914, -0.544405},
{-0.71023, -0.17679, -0.46791, -0.922886, 0.0958235, 0.373031, -0.590962},
{-0.305729, -0.213887, 0.779562, -1.0239, -0.367035, 0.647872, -0.168749},
{0.663648, 0.856434, 0.980169, -0.362715, 0.0177805, 0.622119, 0.724955},
{-1.38879, 0.537994, 0.568901, 0.789372, -0.481598, 0.447293, 1.85636},
{0.832331, -0.0293993, 0.526732, 0.636564, -0.707103, 0.447656, 0.0978167},
{0.212905, 0.183048, 0.154473, 0.380441, 0.36402, -0.717995, -0.346318},
{1.09347, -1.24074, 0.269575, -0.220052, -1.04303, -0.571542, -0.108852},
{-1.36967, 1.54605, -0.386033, -0.454854, -0.770637, -0.827927, 1.11023},
{0.12923, -0.841458, -0.200536, -0.00821709, -0.414961, -0.622522, 0.099289},
{-0.186123, 0.363833, 0.152192, 0.55666, -0.157087, 0.981278, -0.815387},
{0.114001, -1.42821, 1.48884, 0.489539, -0.183599, -0.359886, -0.756844},
{-1.18299, -0.109571, -0.612744, -0.609516, 0.825325, 1.01681, -0.408366},
{-0.440444, -0.56246, -0.854319, -0.143374, 0.74694, -0.294425, 0.101317},
{-0.935363, -0.546071, -0.615697, 0.732017, 0.952606, 0.311198, 1.17323},
{-0.0487839, -0.271653, 1.55497, -0.79747, -0.286433, -0.645642, 0.409918},
{0.497571, 0.250349, 0.51178, -0.390968, -0.305328, -0.975788, 0.633771},
{-0.912343, 0.124061, 0.527763, -0.965201, -0.789523, 0.335717, -0.409425},
{0.371873, 0.235263, -0.0391318, 0.176136, 0.522694, 0.330875, 0.28781},
{-0.424036, 0.729109, 0.711656, -0.517694, -0.505784, 0.725895, -0.262936},
{-0.501685, -0.474841, 0.880407, 0.638227, -0.387853, -0.680175, 0.854119},
{0.354607, -0.682832, 0.0368338, -0.580881, 0.0995848, 0.69629, 0.565319},
{-0.731719, -1.07478, 0.692341, -1.03911, 0.392581, -0.32427, -0.856952},
{-0.432577, 0.349591, -0.197118, -0.097363, 0.0997593, -0.813728, -0.68073},
{-0.980907, 0.972015, 0.541518, -0.339644, 1.2343, 0.406927, -0.149887},
{0.0866479, -0.163147, 0.271591, 0.0133866, -0.464883, 0.467682, 0.127277},
{0.827083, 0.86332, 0.729094, 0.0315204, -1.02418, -0.388069, 0.360959},
{0.912034, -0.784362, 0.907782, 0.794992, -0.0902277, 0.483161, -0.298695},
{0.53919, 0.104624, -0.708698, -0.764722, 0.670921, -0.669671, 0.819337},
{-0.491726, 0.295202, -0.0752932, -0.11741, -0.671723, -0.981349, -1.11191},
{0.551722, -0.19218, -0.61537, -0.0561907, 0.541154, 0.941917, 0.854418},
{0.389776, -0.274358, 0.356071, 0.333133, 1.36493, 0.160435, 0.135441},
{-1.36357, 1.39796, 0.30732, 0.763448, -0.16565, -0.324341, 0.417811},
{-0.429383, -0.739466, -0.359276, 0.242359, -0.203434, -0.231338, 0.416596},
{-0.0311542, 0.0178752, 0.462685, 0.74158, -0.833454, 0.875423, 0.352807},
{0.910156, 0.766074, -0.745207, 0.204788, -0.919472, -0.392365, -0.352123},
{-0.178614, 1.41486, -0.693156, 0.444491, 0.796418, 0.877446, 1.57139},
{-0.146939, 0.310335, -1.06334, 0.411102, -0.604056, -0.142877, 0.591434},
{-0.0227082, 0.0660575, 0.416943, 0.687421, 0.365271, 0.645317, -0.222208},
{0.709886, 0.308937, 0.613072, -1.20217, 0.783159, -0.611563, 0.396525},
{0.40968, 0.685545, -0.190335, -0.899989, -0.287995, 0.0326613, 0.33195},
{0.506688, -0.194126, 0.774272, -0.943463, -0.487453, -0.310353, -0.112941},
{0.522551, -0.00173499, 0.626509, -0.848184, 0.719194, -0.869967, 0.647684},
{0.0262786, -0.374946, 0.728248, 0.829256, -0.374634, 0.26409, -0.230819},
{-0.321599, 0.0188561, 0.660178, -0.24776, 0.854709, 0.924848, 0.726845}},
{{1.05055, 1.42061, -1.71698, 1.5835},
{0.563129, 0.072751, 1.5359, -1.95908},
{0.220971, 2.78301, -1.47425, 1.30683},
{-0.297352, 0.916352, 0.511124, -0.916072},
{0.453752, -2.51437, 1.28305, -0.147888},
{-0.248237, -1.22331, 0.44941, 0.098175},
{-0.566785, -0.431258, 2.33539, -0.763545}},
{{0.804416, -0.169885, 0.0462909, 0.639817, 0.811004, 0.470319, 0.997757, -0.781636, 0.609104},
{-2.49434, -0.789624, 0.600236, 2.76406, 0.119697, -3.7103, 0.105594, -1.72003, 0.0133932},
{0.371872, 3.11721, 1.06238, -1.11082, -2.83857, 1.17966, -0.945737, 0.36224, 0.971889},
{-0.522318, -1.4727, -1.94758, 1.46251, 1.68191, 0.521203, -0.0305644, 0.160495, 0.0929635}},
{{0.848962, -2.26377, 0.485575},
{2.28335, 1.49545, -1.85288},
{-0.709853, 1.66368, -1.70426},
{-3.68143, 1.0727, 1.18326},
{-1.63054, -2.79296, 2.19773},
{2.19858, -3.33695, 0.238195},
{-1.24695, -1.0165, 0.275358},
{0.742879, -1.45016, 0.138684},
{-0.493548, 0.0580598, -0.525922}} };
}
